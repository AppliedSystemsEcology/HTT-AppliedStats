---
title: "HTT_AppliedStats_FinalProject_2025"
format: html
---
```{r}
# via Quarto: Ensure that the code used to generate markdown isn't included in the final output
#| echo: false
```

```{r}
# Load libraries
library(tidyverse)
library(dplyr)
library(purrr)
library(openxlsx)
```

```{r}
# Reads in data from raw excel files and writes them out as copies into different directory

## Damage data
# damage rating local file path
damage_filepath <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/raw_data"

# change wd to damage file path
setwd(damage_filepath)

# read in excel data files
TomatoThripsDamageRS <- read.xlsx(xlsxFile = "HTTFruitRating_2025.xlsx", sheet = 2, detectDates = TRUE)
TomatoThripsDamageSEAREC <- read.xlsx(xlsxFile = "HTTFruitRating_2025.xlsx", sheet = 1, detectDates = TRUE)

## write files into different project directory
# file path to stats project directory RS
appliedstats_filepath_RSDamage <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data/TomatoThripsDamageRS.xlsx"

# write damage data to applied stats directory
write.xlsx(TomatoThripsDamageRS, file = appliedstats_filepath_RSDamage, sheetName = "TomatoThripsDamageRS")

# file path to stats project directory SEAREC
appliedstats_filepath_SEARECDamage <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data/TomatoThripsDamageSEAREC.xlsx"

# write damage data to applied stats directory
write.xlsx(TomatoThripsDamageSEAREC, file = appliedstats_filepath_SEARECDamage, sheetName = "TomatoThripsDamageSEAREC")

#################################
## Ground cover data
# ground cover ID local file path
groundcover_filepath <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/logistics_and_mgmt"

# change wd to ground cover file path
setwd(groundcover_filepath)

# read in excel data files
GroundCoverID <- read.xlsx(xlsxFile = "Site_GroundCover_2025.xlsx", sheet = 1, rows = 1:13)

# file path to stats project directory ground_cover_ID
appliedstats_filepath_GroundCoverID <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data/Site_GroundCover_2025.xlsx"

# write ground cover ID data to applied stats directory
write.xlsx(GroundCoverID, file = appliedstats_filepath_GroundCoverID, sheetName = "Site_GroundCover_2025")

#######################################################

## Temperature sensor data
# temperature sensors local file paths RS
temperature_RS_directory <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/raw_data/tempsensor_export/RockSprings"

# set wd to temp data RS
setwd(temperature_RS_directory)

# list of excel files in local directory
temperature_list_RS <- list.files(path = temperature_RS_directory, pattern = "^RS_")

# new directory location
appliedstats_filepath_temp_RS <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data/"

for (i in seq_along(temperature_list_RS)) {
  # read excel files
  xlsxFileRS <- read.xlsx(paste0(temperature_RS_directory,"/",temperature_list_RS[i]), detectDates = TRUE, colNames = FALSE)
   # Add "temp_" prefix to file name
  new_filename <- paste0("temp_", temperature_list_RS[i])

  # write into new directory as excel files
  write.xlsx(xlsxFileRS, paste0(appliedstats_filepath_temp_RS, "/", new_filename)
  )
}


# repeat for SEAREC
# temperature sensors local file paths SEAREC
temperature_SEAREC_directory <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/raw_data/tempsensor_export/SEAREC"

# set wd to temp data SEAREC
setwd(temperature_SEAREC_directory)

# list of excel files in local directory
temperature_list_SEAREC <- list.files(path = temperature_SEAREC_directory, pattern = "^SEAREC_")

# new directory location
appliedstats_filepath_temp_SEAREC <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data/"

for (i in seq_along(temperature_list_SEAREC)) {
  # read excel files
  xlsxFileSEAREC <- read.xlsx(paste0(temperature_SEAREC_directory,"/",temperature_list_SEAREC[i]), detectDates = TRUE, colNames = FALSE)
   # Add "temp_" prefix to file name
  new_filename <- paste0("temp_", temperature_list_SEAREC[i])
  # write into new directory as excel files
  write.xlsx(xlsxFileSEAREC, paste0(appliedstats_filepath_temp_SEAREC, "/", new_filename)
  )
}

```




```{r}
# Set working directory in terminal
# setwd("C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data")

# Load tomato thrips damage data from local environment
TomatoThripsDamageRS <- read.xlsx("TomatoThripsDamageRS.xlsx", detectDates = TRUE)
TomatoThripsDamageSEAREC <- read.xlsx("TomatoThripsDamageSEAREC.xlsx", detectDates = TRUE)

# Load ground cover ID data from local environment
GroundCoverID <- read.xlsx("Site_GroundCover_2025.xlsx", detectDates = TRUE)

# Create data frame for tomato thrips damage for both RS and SEAREC sites
TomatoThripsDamage_raw <- bind_rows(TomatoThripsDamageRS, TomatoThripsDamageSEAREC)

# Change column name 'ground cover' to 'plot_ID'
TomatoThripsDamage_raw <- TomatoThripsDamage_raw %>%
  rename(plot_ID = ground_cover)
  
# Add 'ground_cover' column to combined data
TomatoThripsDamage_raw <- left_join(TomatoThripsDamage_raw, GroundCoverID, by = "plot_ID")

# Subset to remove redundant columns "X", "site.y", and "year"
TomatoThripsDamage <- subset(TomatoThripsDamage_raw, select= -c(X6, year, site.y))

# Rename column 'site.x' to 'site'
TomatoThripsDamage <- TomatoThripsDamage %>%
  rename(site = site.x) %>%
  # change grade and damage_rating to factors
  mutate(grade = as.factor(grade), 
  damage_rating = as.factor(damage_rating))
```

```{r}
# Tidy temperature data
# path of directory
temperature_directory <-"C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data"

# List temperature files from local path 
temperature_list <- list.files(path = temperature_directory, pattern = "^temp_")

# Create data frame names for temp_list without ".xlsx" at end
temperature_names <- sub("\\.xlsx$", "", temperature_list)

# loop to read in excel files
for (i in temperature_names) {
# set file path
  filepath <- file.path(path = temperature_directory, 
  paste(i, ".xlsx", sep = ""))
# read each file and name it the file name
  assign(i, 
    read.xlsx(xlsxFile = filepath,
    startRow = 22,
    colNames = FALSE,
    detectDates = TRUE
    ))
}



## Tidy over multiple data frames
# Create list of temp dataframes
temperature_df_list <- mget(ls(.GlobalEnv, pattern = "^temp_")

temperature_df_list_purrr <- purrr::map2(
  # Defines list of data frames
  .x = temperature_df_list,
  # Defines list of strings that correspond to data fram names
  .y = temperature_names,
  .f = ~ .x %>%
     rename(date = X1,
    time = X2,
    temperature_c = X3,
    humidity_rh = X4) %>%
    mutate(date = as.Date(date), 
      temperature_c = as.numeric(temperature_c),
      humidity_rh = as.numeric(humidity_rh)) %>%
    # make sensor_ID column, named as file name
    mutate(sensor_ID = .y) %>%
    # Create columns from file name contents
# add column for 'below' or 'above'
# add column for site
# add column for groundcover
# add column for replacement
    separate(col = sensor_ID, into = c("temp", "site", "plot_ID_row", "sensor_placement", "replacement"), sep = "_") %>%
  # delete dummy temp column
    select(!(temp)) %>%
    # make new columns plot_ID and row
    mutate(
      plot_ID = substr(plot_ID_row, 1,1), row = substr(plot_ID_row,2,2)) %>%
    # remove column plot_ID_row
    select(!(plot_ID_row))
    # lubridate on date and time columns to change data types
    )

# update changes to dataframe list in the global environment
list2env(temperature_df_list_purrr, .GlobalEnv)

# make df_list into combined dataframe




```