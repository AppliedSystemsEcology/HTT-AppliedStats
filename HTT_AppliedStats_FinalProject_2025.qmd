---
title: "HTT_AppliedStats_FinalProject_2025"
format: html
---
```{r}
# via Quarto: Ensure that the code used to generate markdown isn't included in the final output
#| echo: false
```

```{r}
# Load libraries
library(tidyverse)
library(dplyr)
library(purrr)
library(openxlsx)
library(ggplot2)
library(hms)
```

```{r}
## DO NOT RUN, FILES ALREADY EXIST 
# Reads in data from raw excel files and writes them out as copies into different directory

## Damage data
# damage rating local file path
damage_filepath <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/raw_data"

# change wd to damage file path
setwd(damage_filepath)

# read in excel data files
TomatoThripsDamageRS <- read.xlsx(xlsxFile = "HTTFruitRating_2025.xlsx", sheet = 2, detectDates = TRUE)
TomatoThripsDamageSEAREC <- read.xlsx(xlsxFile = "HTTFruitRating_2025.xlsx", sheet = 1, detectDates = TRUE)

## write files into different project directory
# file path to stats project directory RS
appliedstats_filepath_RSDamage <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data/TomatoThripsDamageRS.xlsx"

# write damage data to applied stats directory
write.xlsx(TomatoThripsDamageRS, file = appliedstats_filepath_RSDamage, sheetName = "TomatoThripsDamageRS")

# file path to stats project directory SEAREC
appliedstats_filepath_SEARECDamage <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data/TomatoThripsDamageSEAREC.xlsx"

# write damage data to applied stats directory
write.xlsx(TomatoThripsDamageSEAREC, file = appliedstats_filepath_SEARECDamage, sheetName = "TomatoThripsDamageSEAREC")

#################################
## Ground cover data
# ground cover ID local file path
groundcover_filepath <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/logistics_and_mgmt"

# change wd to ground cover file path
setwd(groundcover_filepath)

# read in excel data files
GroundCoverID <- read.xlsx(xlsxFile = "Site_GroundCover_2025.xlsx", sheet = 1, rows = 1:13)

# file path to stats project directory ground_cover_ID
appliedstats_filepath_GroundCoverID <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data/Site_GroundCover_2025.xlsx"

# write ground cover ID data to applied stats directory
write.xlsx(GroundCoverID, file = appliedstats_filepath_GroundCoverID, sheetName = "Site_GroundCover_2025")

#######################################################

## Temperature sensor data
# temperature sensors local file paths RS
temperature_RS_directory <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/raw_data/tempsensor_export/RockSprings"

# set wd to temp data RS
setwd(temperature_RS_directory)

# list of excel files in local directory
temperature_list_RS <- list.files(path = temperature_RS_directory, pattern = "^RS_")

# new directory location
appliedstats_filepath_temp_RS <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data/"

for (i in seq_along(temperature_list_RS)) {
  # read excel files
  xlsxFileRS <- read.xlsx(paste0(temperature_RS_directory,"/",temperature_list_RS[i]), detectDates = TRUE, colNames = FALSE)
   # Add "temp_" prefix to file name
  new_filename <- paste0("temp_", temperature_list_RS[i])

  # write into new directory as excel files
  write.xlsx(xlsxFileRS, paste0(appliedstats_filepath_temp_RS, "/", new_filename)
  )
}


# repeat for SEAREC
# temperature sensors local file paths SEAREC
temperature_SEAREC_directory <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/raw_data/tempsensor_export/SEAREC"

# set wd to temp data SEAREC
setwd(temperature_SEAREC_directory)

# list of excel files in local directory
temperature_list_SEAREC <- list.files(path = temperature_SEAREC_directory, pattern = "^SEAREC_")

# new directory location
appliedstats_filepath_temp_SEAREC <- "C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data/"

for (i in seq_along(temperature_list_SEAREC)) {
  # read excel files
  xlsxFileSEAREC <- read.xlsx(paste0(temperature_SEAREC_directory,"/",temperature_list_SEAREC[i]), detectDates = TRUE, colNames = FALSE)
   # Add "temp_" prefix to file name
  new_filename <- paste0("temp_", temperature_list_SEAREC[i])
  # write into new directory as excel files
  write.xlsx(xlsxFileSEAREC, paste0(appliedstats_filepath_temp_SEAREC, "/", new_filename)
  )
}

```

```{r}
# Set working directory in terminal
# setwd("C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data")

# Load tomato thrips damage data from local environment
TomatoThripsDamageRS <- read.xlsx("TomatoThripsDamageRS.xlsx", detectDates = TRUE)
TomatoThripsDamageSEAREC <- read.xlsx("TomatoThripsDamageSEAREC.xlsx", detectDates = TRUE)

# Load ground cover ID data from local environment
GroundCoverID <- read.xlsx("Site_GroundCover_2025.xlsx", detectDates = TRUE)

# Create data frame for tomato thrips damage for both RS and SEAREC sites
TomatoThripsDamage_raw <- bind_rows(TomatoThripsDamageRS, TomatoThripsDamageSEAREC)

# Change column name 'ground cover' to 'plot_ID'
TomatoThripsDamage_raw <- TomatoThripsDamage_raw %>%
  rename(plot_ID = ground_cover)
  
# Add 'ground_cover' column to combined data
TomatoThripsDamage_raw <- left_join(TomatoThripsDamage_raw, GroundCoverID, by = "plot_ID")

# Subset to remove redundant columns "X", "site.y", and "year"
TomatoThripsDamage <- subset(TomatoThripsDamage_raw, select= -c(X6, year, site.y))

# Rename column 'site.x' to 'site'
TomatoThripsDamage <- TomatoThripsDamage %>%
  rename(site = site.x) %>%
  # change grade and damage_rating to factors
  # add julian_day column
  mutate(grade = as.factor(grade), 
  damage_rating = as.factor(damage_rating)) %>%
  mutate(damage_rating = factor(damage_rating, levels = c("3", "2", "1", "0")),
    julian_day = yday(date)) 


head(TomatoThripsDamage)
summary(TomatoThripsDamage)
```

```{r}
# Tidy temperature data
# path of directory
temperature_directory <-"C:/Users/mykal/OneDrive - The Pennsylvania State University/Grab Lab - Mykalas_Projects - Documents/Mykalas_Projects/projects/High Tunnel Thrips/analysis/HTT-AppliedStats/data"

# List temperature files from local path 
temperature_list <- list.files(path = temperature_directory, pattern = "^temp_")

# Create data frame names for temp_list without ".xlsx" at end
temperature_names <- sub("\\.xlsx$", "", temperature_list)

# loop to read in excel files
for (i in temperature_names) {
# set file path
  filepath <- file.path(path = temperature_directory, 
  paste(i, ".xlsx", sep = ""))
# read each file and name it the file name
  assign(i, 
    read.xlsx(xlsxFile = filepath,
    startRow = 22,
    colNames = FALSE,
    detectDates = TRUE
    ))
}

## Tidy over multiple data frames
# Create list of temp dataframes
temperature_df_list <- mget(ls(.GlobalEnv, pattern = "^temp_"))

temperature_df_list_purrr <- map2( 
  # Defines list of data frames
  .x = temperature_df_list,
  # Defines list of strings that correspond to data fram names
  .y = temperature_names,
  # Defines function to apply -- must use parentheses before .x to get dplyr to work!!
  .f = ~ (.x %>%
    rename(date = X1,
    time = X2,
    temperature_c = X3,
    humidity_rh = X4) %>%
    mutate(date = as.Date(date), 
      time = hms::as_hms(time),
      temperature_c = as.numeric(temperature_c),
      humidity_rh = as.numeric(humidity_rh)) %>%
    # make sensor_ID column, named as file name
    mutate(sensor_ID = .y) %>%
    # Create columns from file name contents
    # add column for 'below' or 'above'
    # add column for site
    # add column for groundcover
    # add column for replacement
    separate(col = sensor_ID, into = c("temp", "site", "plot_ID_row", "sensor_placement", "replacement"), sep = "_") %>%
  # delete dummy temp column
    mutate(temp = NULL) %>%
    # make new columns plot_ID and row
    mutate(plot_ID = substr(plot_ID_row, 1,1), row = substr(plot_ID_row,2,2)) %>%
    # remove column plot_ID_row
    mutate(plot_ID_row = NULL) %>%
    # lubridate create date_time column as date-time data type
    mutate(date_time = ymd_hms(paste(date, time))) %>%
    # add julian_day column
    # assign 'day' and 'night' to 6AM-8PM for summer daylight coverage
    mutate(julian_day = yday(date),
      day_night = dplyr::case_when(
        between(time, hms::as_hms("06:00:00"), hms::as_hms("20:00:00")) ~ "daytime",
        TRUE ~ "nighttime")
      )
  )
)


# update changes to dataframe list in the global environment
list2env(temperature_df_list_purrr, .GlobalEnv)

# make df_list into combined dataframe
Temperature_raw <- bind_rows(temperature_df_list_purrr, .id = "column_label") %>%
    rename(sensor_ID = column_label)

# add ground cover to temp sensor data by plot_ID
Temperature <- Temperature_raw %>%
  left_join(GroundCoverID %>%
   dplyr::select(ground_cover, plot_ID), by = "plot_ID")

# Aggregate data frame for mean temperature_c 
Temperature.agg <- Temperature %>%
  group_by(julian_day, site, sensor_placement, ground_cover, plot_ID, day_night) %>%
  summarize(mean_temperature_c = mean(temperature_c, na.rm = TRUE))

# Temperature subsets for above- and below-ground
# Above-ground
Temperature_above <- Temperature.agg %>%
  subset(sensor_placement == "a")
# Below-ground
Temperature_below <- Temperature.agg %>%
  subset(sensor_placement == "b")

```

```{r}
library(MASS)
library(ordinal)
library(rcompanion)
library(brant)
library(car)
## Finally time for analysis!

############ Thrips Damage ##############
## Research question: Is thrips damage severity on tomato fruits impacted by ground cover type in high tunnel tomatoes?
# Null hypothesis: Thrips damage severity does not differ across ground cover type.
# Response variable: damage severity (categorical-ordinal)
# Predictor variable: ground cover (categorical-discrete)
# Other predictor variables:  site (categorical-nominal), date (not sure type of data) or julian_day(numerical-continuous)
# Data: TomatoThripsDamage

# Look at raw data first
ggplot(data = TomatoThripsDamage, aes(x = ground_cover, y = damage_rating, color = site)) +
  geom_jitter() +
  facet_wrap(~site)

# labellers
severity_colors <- c("0" = "#390099", "1" = "#9E0059", "2"= "#FF0054", "3" = "#FF5400")
severity_labels <- c("0" = "None", "1" = "Mild", "2"= "Moderate", "3" = "Severe")
ground_cover_labels <- c("fabric" = "Fabric", "soil" = "Soil", "straw" = "Straw")

# Damage severity by ground cover raw
ggplot(TomatoThripsDamage, aes(x = ground_cover, fill = damage_rating)) +
  geom_histogram(stat = "count") +
  facet_wrap(~site) +
  labs(x = "Ground Cover", y = "Fruit Count", fill = "Damage Severity") +
  scale_fill_manual(values = severity_colors, labels = severity_labels) +
  scale_x_discrete(labels = ground_cover_labels)

# damage severity over time facet wrapped by ground cover and site
ggplot(TomatoThripsDamage, aes(x = date, color = damage_rating)) +
  geom_line(stat = "count") + 
  facet_grid(site ~ ground_cover) +
  labs(x = "Date", y = "Fruit Count", color = "Damage Severity") +
  scale_color_manual(values = severity_colors, labels = severity_labels)

# Proposed model
# damage~site*ground_cover*date
## try ordered logistic regression
# may need some help on how to do this

# ordered logistic regression
# models the relationship between the predictors and an outcome variable with three or more categories that have a natural order
# polr () - proportional odds logistic regression
# Hess=TRUE for the model to return the observed information matrix from optimization which is used to get standard errors

# can you include random effects in logistic regression?
## ggplot by plot to see if theres visual difference

# model with julian_day instead of date
damage.model <- polr(damage_rating~site*ground_cover*julian_day, data=TomatoThripsDamage, Hess=TRUE)
summary(damage.model)

# look at significance of variables
## store table
(ctable <- coef(summary(damage.model)))
## calculate and store p values
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
## combined table
(ctable <- cbind(ctable, "p value" = p))

# model with no interaction terms, use this model over one with interactions
damage.model <- polr(damage_rating~site+ground_cover+julian_day, data=TomatoThripsDamage, Hess=TRUE)
summary(damage.model)
# the first model with interaction terms has a slightly higher AIC, indicating a better model?
# output are log-odds
# may need to back-transfrom for interpretation

# I'm having a hard time interpreting this model and doing model selection here
# I'm not sure how to decide when to include interaction terms?

# maybe try multinomial

####### two models, one for each site since site has a large effect (remove site from model)
library(nnet)
# establish baseline
TomatoThripsDamage$damage_rating_baseline <- relevel(TomatoThripsDamage$damage_rating, ref = "0")
#multinomial logistic regression model
m <- multinom(damage_rating_baseline~site+ground_cover+julian_day, data = TomatoThripsDamage)
summary(m)
z <- summary(m)$coefficients/summary(m)$standard.errors
z
p <- (1 - pnorm(abs(z), 0, 1)) * 2
p

####### Temperature ##########
## Research question: Is above- or below-ground temperature impacted by ground cover type in high-tunnel tomatoes?
# Null hypothesis: Average temperature (below or above ground) does not differ across ground cover type. 
# Proposed model
# temperature~site*sensor_placement*ground_cover*julian_day
# If sensor placement is sig, then maybe make two different models; one for above and one for below? yes to this
# include random effects maybe?


# Look at data first
ggplot(data = Temperature, aes(x = sensor_placement, y = temperature_c, color = ground_cover)) +
  geom_boxplot() +
  stat_summary(fun = "mean") +
  facet_wrap(~site)

# raw temp data
hist(Temperature$temperature_c)
# looks pretty normal!
qqnorm(Temperature$temperature_c)
qqline(Temperature$temperature_c)
# these don't look great

# Look at aggregate data mean temp
ggplot(data = Temperature.agg, aes(x = sensor_placement, y = mean_temperature_c, color = ground_cover)) +
  geom_boxplot() +
  facet_wrap(~site)

# mean temp data
hist(Temperature.agg$mean_temperature_c)
qqnorm(Temperature.agg$mean_temperature_c)
qqline(Temperature.agg$mean_temperature_c)

hist(Temperature_above$mean_temperature_c)
hist(Temperature_below$mean_temperature_c)


# Look at aggregate data mean temp with day_night
ggplot(data = Temperature.agg, aes(x = sensor_placement, y = mean_temperature_c, color = ground_cover)) +
  geom_boxplot() +
  facet_grid(day_night~site)

ggplot(data = Temperature.agg, aes(x = sensor_placement, y = mean_temperature_c, color = ground_cover)) +
geom_boxplot() +
facet_grid(day_night~site)

ggplot(data = Temperature.agg, aes(mean_temperature_c, color = ground_cover)) +
geom_histogram() +
facet_grid(day_night~site+ground_cover)

###### two models above and below ground
# continue in this vein
# above
# needs transformation
t_above <- lm(mean_temperature_c~site+ground_cover+julian_day+day_night+ I(julian_day^2), data = Temperature_above)
summary(t_above)

ggplot(Temperature_above, aes(x=julian_day, y=mean_temperature_c))+
geom_point()


sqrt(mean(Temperature_above$mean_temperature_c))
var(Temperature_above$mean_temperature_c)
# look at residuals
plot(residuals(t_above))





















# null model
temperature.null <- lm(mean_temperature_c~1, data = Temperature.agg)
# full model
temperature.full <- lm(mean_temperature_c~sensor_placement*ground_cover*site*julian_day*day_night, data = Temperature.agg)
vif(temperature.full, type = "predictor")
plot(residuals(temperature.full))




 

# step model selection
step(temperature.null,
     scope = list(upper=temperature.full),
     direction="both",
     data=Temperature)
# this is crazy, too many interactions











# Above-ground
# Response variable: above-ground temperature (numeric-continuous)
# Predictor variable: ground cover (categorical-discrete)
# Data: Temperature_above
temperature_above.lm <- lm(temperature_c~ground_cover, data = Temperature_above)
summary(temperature_above.lm)


# Below-ground
# Response variable: below-ground temperature (numeric-continuous)
# Predictor variable: ground cover (categorical-discrete)
# Data: Temperature_below










```